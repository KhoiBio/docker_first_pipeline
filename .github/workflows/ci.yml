name: Docker Pipeline CI

# Trigger on push or PR to main branch
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the repo
    - name: Checkout repository
      uses: actions/checkout@v3

    # Step 2: Build Docker image
    - name: Build Docker image
      run: docker build -t docker_first_pipeline:latest docker/

    # Step 3: Run ATAC-seq pipeline as test
    - name: Run ATAC-seq pipeline
      run: |
        mkdir -p test_output
        docker run --rm \
          -v ${{ github.workspace }}/test_data:/data \
          -v ${{ github.workspace }}/test_output:/output \
          docker_first_pipeline:latest \
          /pipeline/workflow/run_atac.sh /data/sample_R1.fastq.gz /data/sample_R2.fastq.gz GENOME_INDEX

    # Step 4: (Optional) Run RNA-seq pipeline
    #- name: Run RNA-seq pipeline
#      run: |
#        docker run --rm \
#          -v ${{ github.workspace }}/test_data:/data \
#          -v ${{ github.workspace }}/test_output:/output \
#          docker_first_pipeline:latest \
#          /pipeline/workflow/run_rnaseq.sh /data/sample.fastq.gz GENOME_INDEX
