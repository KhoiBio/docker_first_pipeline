
name: Docker Pipeline CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Verify repo structure
        run: ls -R

      - name: Build Docker image
        run: |
          docker build --progress=plain \
            -t docker_first_pipeline:ci \
            -f ./docker/Dockerfile .

      # Debug tools inside container
      - name: Debug container environment
        run: |
          docker run --rm docker_first_pipeline:ci bash -c "
            echo 'Checking tools:' &&
            command -v samtools || echo 'samtools missing' &&
            command -v bwa || echo 'bwa missing' &&
            command -v trim_galore || echo 'trim_galore missing' &&
            command -v bedtools || echo 'bedtools missing' &&
            command -v picard || echo 'picard missing'
          "

      # Debug input files
      - name: Debug input files
        run: |
          echo 'Host input files:'
          ls -lh test_data || echo 'test_data missing'
          ls -lh reference || echo 'reference missing'

      # RNA pipeline
      - name: Run RNA pipeline test
        run: |
          mkdir -p output_rna
          docker run --rm \
            -v $PWD/test_data:/data/test_data \
            -v $PWD/output_rna:/data/test_output_rna \
            -v $PWD/reference:/data/reference \
            docker_first_pipeline:ci \
            bash /pipeline/workflow/run_rna_ci.sh \
            /data/test_data/rna_R1.fastq.gz \
            /data/test_data/rna_R2.fastq.gz \
            /data/reference/test_reference.fa \
            /data/test_output_rna

      - name: Debug RNA output inside container
        run: |
          docker run --rm \
            -v $PWD/output_rna:/data/test_output_rna \
            docker_first_pipeline:ci \
            bash -c "echo 'Container output:' && ls -R /data/test_output_rna || echo 'No files inside container'"

      - name: Check RNA output files on host
        run: |
          echo "RNA output directory on host:"
          ls -R output_rna || echo "No RNA output found"
          if [ ! "$(ls -A output_rna)" ]; then
            echo "RNA pipeline produced no output" && exit 1
          fi
